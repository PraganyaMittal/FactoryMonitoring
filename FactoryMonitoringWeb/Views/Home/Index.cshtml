@model FactoryMonitoringWeb.Models.DashboardViewModel

@{
    ViewData["Title"] = "Factory Dashboard";
    var selectedVersion = Model.SelectedVersion ?? "All Versions";
}

<div class="dashboard-shell">
    <aside class="sidebar">
        <div class="sidebar-section">
            <h2>Versions</h2>
            <ul class="version-list">
                <li class="@(Model.SelectedVersion == null ? "active" : "")">
                    <a href="@Url.Action("Index", "Home", new { version = (string)null, viewMode = Model.ViewMode })">
                        All Versions
                    </a>
                </li>
                @foreach (var v in Model.Versions)
                {
                    <li class="@(Model.SelectedVersion == v ? "active" : "")">
                        <a href="@Url.Action("Index", "Home", new { version = v, viewMode = Model.ViewMode })">
                            @v
                        </a>
                    </li>
                }
            </ul>
        </div>

        <div class="sidebar-section">
            <h2>Model Management</h2>
            <p class="sidebar-help">
                Upload a model ZIP and apply it to selected PCs. One model is uploaded to server and all selected agents download and apply it.
            </p>
            <form id="sidebarBulkUploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="sidebarModelFile">Model ZIP File:</label>
                    <input type="file" id="sidebarModelFile" name="modelFile" accept=".zip" required />
                </div>
                <div class="form-group">
                    <label>Apply To:</label>
                    <select id="sidebarTargetType" name="targetType" class="form-control">
                        <option value="all">All PCs</option>
                        <option value="version">By Version</option>
                        <option value="line">By Line</option>
                        <option value="lineandversion">By Line + Version</option>
                    </select>
                </div>
                <div class="form-group" id="versionSelectGroup" style="display:none;">
                    <label for="sidebarVersionSelect">Select Version:</label>
                    <select id="sidebarVersionSelect" name="version" class="form-control">
                        @foreach (var v in Model.Versions)
                        {
                            <option value="@v" selected="@(Model.SelectedVersion == v)">@v</option>
                        }
                    </select>
                </div>
                <div class="form-group" id="lineSelectGroup" style="display:none;">
                    <label for="sidebarLineSelect">Select Line:</label>
                    <select id="sidebarLineSelect" name="lineNumber" class="form-control">
                        @foreach (var line in Model.LineNumbers)
                        {
                            <option value="@line">Line @line</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sidebarApplyOnUpload" name="applyOnUpload" checked />
                        Apply model immediately after download
                    </label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Upload & Apply to Selected PCs</button>
                <div id="sidebarBulkUploadStatus" class="upload-status" style="margin-top:10px;"></div>
            </form>
        </div>
    </aside>

    <section class="dashboard-main">
        <div class="dashboard-header">
            <div>
                <h1>Factory PCs - @selectedVersion</h1>
                <p class="dashboard-subtitle">
                    View and manage PCs by version. Switch between card and list views.
                </p>
            </div>
            <div class="view-toggle">
                <a class="btn btn-secondary @(Model.ViewMode == "cards" ? "active" : "")"
                   href="@Url.Action("Index", "Home", new { version = Model.SelectedVersion, viewMode = "cards" })">
                    Card View
                </a>
                <a class="btn btn-secondary @(Model.ViewMode == "list" ? "active" : "")"
                   href="@Url.Action("Index", "Home", new { version = Model.SelectedVersion, viewMode = "list" })">
                    List View
                </a>
            </div>
        </div>

        @if (!Model.PCs.Any())
        {
            <div class="no-data">
                <p>No PCs registered yet for this filter. Please run the agent on factory PCs to register them.</p>
            </div>
        }
        else if (Model.ViewMode == "list")
        {
            <div class="table-container">
                <table class="pc-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Version</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <th>App</th>
                            <th>Current Model</th>
                            <th>Last Updated</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pc in Model.PCs)
                        {
                            var currentModel = pc.Models.FirstOrDefault(m => m.IsCurrentModel);
                            <tr class="@(pc.IsOnline ? "online" : "offline")">
                                <td><strong>Line @pc.LineNumber - PC @pc.PCNumber</strong></td>
                                <td>@pc.ModelVersion</td>
                                <td>@pc.IPAddress</td>
                                <td>
                                    <span class="badge @(pc.IsOnline ? "badge-success" : "badge-danger")">
                                        @(pc.IsOnline ? "Online" : "Offline")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @(pc.IsApplicationRunning ? "badge-success" : "badge-secondary")">
                                        @(pc.IsApplicationRunning ? "Running" : "Stopped")
                                    </span>
                                </td>
                                <td><strong>@(currentModel?.ModelName ?? "None")</strong></td>
                                <td>@pc.LastUpdated.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>
                                    <a href="@Url.Action("Details", "PC", new { id = pc.PCId })"
                                       class="btn btn-sm btn-info">Details</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="pc-grid">
                @foreach (var pc in Model.PCs)
                {
                    var currentModel = pc.Models.FirstOrDefault(m => m.IsCurrentModel);
                    <a href="@Url.Action("Details", "PC", new { id = pc.PCId })"
                       class="pc-card @(pc.IsOnline ? "online" : "offline")">
                        <div class="pc-icon">
                            <span class="status-indicator @(pc.IsOnline ? "online" : "offline")"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"
                                 fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 4s0-2 2-2h12s2 0 2 2v6s0 2-2 2h-4c0 .667.083 1.167.25 1.5H11a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h.75c.167-.333.25-.833.25-1.5H2s-2 0-2-2V4zm1.398-.855a.758.758 0 0 0-.254.302A1.46 1.46 0 0 0 1 4.01V10c0 .325.078.502.145.602.07.105.17.188.302.254a1.464 1.464 0 0 0 .538.143L2.01 11H14c.325 0 .502-.078.602-.145a.758.758 0 0 0 .254-.302 1.464 1.464 0 0 0 .143-.538L15 9.99V4c0-.325-.078-.502-.145-.602a.757.757 0 0 0-.302-.254A1.46 1.46 0 0 0 13.99 3H2c-.325 0-.502.078-.602.145z" />
                            </svg>
                        </div>
                        <div class="pc-info">
                            <h3>Line @pc.LineNumber - PC @pc.PCNumber</h3>
                            <p class="ip-address"><strong>IP:</strong> @pc.IPAddress</p>
                            <p class="pc-version"><strong>Version:</strong> @pc.ModelVersion</p>
                            @if (currentModel != null)
                            {
                                <p class="pc-model"><strong>Current Model:</strong> <span style="color: #2563eb; font-weight: 600;">@currentModel.ModelName</span></p>
                            }
                            else
                            {
                                <p class="pc-model"><strong>Current Model:</strong> <span class="muted">Not synced</span></p>
                            }

                            @if (pc.IsOnline)
                            {
                                <p class="status online">Online</p>
                                <p class="app-status @(pc.IsApplicationRunning ? "running" : "stopped")">
                                    App: @(pc.IsApplicationRunning ? "Running" : "Stopped")
                                </p>
                            }
                            else
                            {
                                <p class="status offline">Offline</p>
                                @if (pc.LastHeartbeat.HasValue)
                                {
                                    <p class="last-seen">
                                        Last seen: @pc.LastHeartbeat.Value.ToString("yyyy-MM-dd HH:mm")
                                    </p>
                                }
                            }
                        </div>
                    </a>
                }
            </div>
        }
    </section>
</div>

@section Scripts {
    <script>
        // Handle target type change to show/hide relevant fields
        document.getElementById('sidebarTargetType').addEventListener('change', function() {
            const targetType = this.value;
            const versionGroup = document.getElementById('versionSelectGroup');
            const lineGroup = document.getElementById('lineSelectGroup');
            
            versionGroup.style.display = (targetType === 'version' || targetType === 'lineandversion') ? 'block' : 'none';
            lineGroup.style.display = (targetType === 'line' || targetType === 'lineandversion') ? 'block' : 'none';
        });

        // Initialize on page load
        document.getElementById('sidebarTargetType').dispatchEvent(new Event('change'));

        // Sidebar bulk upload uses existing ModelController.BulkUploadModel endpoint
        document.getElementById('sidebarBulkUploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('sidebarModelFile');
            const targetTypeSelect = document.getElementById('sidebarTargetType');
            const statusDiv = document.getElementById('sidebarBulkUploadStatus');
            const applyOnUpload = document.getElementById('sidebarApplyOnUpload').checked;

            if (!fileInput.files[0]) {
                statusDiv.innerHTML = 'Please select a file';
                statusDiv.className = 'upload-status error';
                return;
            }

            formData.append('modelFile', fileInput.files[0]);
            formData.append('targetType', targetTypeSelect.value);
            formData.append('applyOnUpload', applyOnUpload);

            const targetType = targetTypeSelect.value;
            
            if (targetType === 'version' || targetType === 'lineandversion') {
                const version = document.getElementById('sidebarVersionSelect').value;
                if (version) {
                    formData.append('version', version);
                }
            }
            
            if (targetType === 'line' || targetType === 'lineandversion') {
                const lineNumber = document.getElementById('sidebarLineSelect').value;
                if (lineNumber) {
                    formData.append('lineNumber', lineNumber);
                }
            }

            statusDiv.innerHTML = 'Uploading model to server...';
            statusDiv.className = 'upload-status info';

            try {
                const response = await fetch('@Url.Action("BulkUploadModel", "Model")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    statusDiv.innerHTML = '✓ ' + result.message + '<br>Affected PCs: ' + result.affectedPCs;
                    statusDiv.className = 'upload-status success';
                    setTimeout(() => location.reload(), 3000);
                } else {
                    statusDiv.innerHTML = '✗ Error: ' + result.message;
                    statusDiv.className = 'upload-status error';
                }
            } catch (error) {
                statusDiv.innerHTML = '✗ Error: ' + error.message;
                statusDiv.className = 'upload-status error';
            }
        });

        // Auto-refresh status every 30s
        setInterval(function () {
            location.reload();
        }, 30000);
    </script>
}
