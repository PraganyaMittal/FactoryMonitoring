@model IEnumerable<FactoryPC>

@{
    ViewData["Title"] = "All PCs Overview";
}

<div class="showall-container">
    <h1>All Factory PCs</h1>

    <div class="bulk-actions">
        <h3>Bulk Model Upload & Apply</h3>
        <form id="bulkUploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="bulkModelFile">Select Model ZIP File:</label>
                <input type="file" id="bulkModelFile" name="modelFile" accept=".zip" required />
            </div>
            <div class="form-group">
                <label>Apply To:</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="targetType" value="all" checked /> All PCs
                    </label>
                    @foreach (var line in Model.Select(p => p.LineNumber).Distinct().OrderBy(l => l))
                    {
                        <label>
                            <input type="radio" name="targetType" value="line" data-line="@line" /> Line @line Only
                        </label>
                    }
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Upload & Apply</button>
        </form>
        <div id="bulkUploadStatus" class="upload-status"></div>
    </div>

    <div class="table-container">
        <table class="pc-table">
            <thead>
                <tr>
                    <th>Line</th>
                    <th>PC #</th>
                    <th>Version</th>
                    <th>PC Name</th>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th>App Running</th>
                    <th>Models</th>
                    <th>Current Model</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var pc in Model)
                {
                    <tr class="@(pc.IsOnline ? "online" : "offline")">
                        <td>@pc.LineNumber</td>
                        <td>@pc.PCNumber</td>
                        <td>@pc.ModelVersion</td>
                        <td>@pc.IPAddress</td>
                        <td>
                            <span class="badge @(pc.IsOnline ? "badge-success" : "badge-danger")">
                                @(pc.IsOnline ? "Online" : "Offline")
                            </span>
                        </td>
                        <td>
                            <span class="badge @(pc.IsApplicationRunning ? "badge-success" : "badge-secondary")">
                                @(pc.IsApplicationRunning ? "Yes" : "No")
                            </span>
                        </td>
                        <td>@pc.Models.Count</td>
                        <td>
                            @{
                                var currentModel = pc.Models.FirstOrDefault(m => m.IsCurrentModel);
                            }
                            @(currentModel?.ModelName ?? "None")
                        </td>
                        <td>@pc.LastUpdated.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>
                            <a href="@Url.Action("Details", "PC", new { id = pc.PCId })" class="btn btn-sm btn-info">Details</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('bulkUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('bulkModelFile');
            const selectedRadio = document.querySelector('input[name="targetType"]:checked');

            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }

            formData.append('modelFile', fileInput.files[0]);
            formData.append('targetType', selectedRadio.value);

            if (selectedRadio.value === 'line') {
                formData.append('lineNumber', selectedRadio.getAttribute('data-line'));
            }

            const statusDiv = document.getElementById('bulkUploadStatus');
            statusDiv.innerHTML = 'Uploading...';
            statusDiv.className = 'upload-status info';

            try {
                const response = await fetch('@Url.Action("BulkUploadModel", "Model")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = result.message + '<br>Affected PCs: ' + result.affectedPCs;
                    statusDiv.className = 'upload-status success';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    statusDiv.innerHTML = 'Error: ' + result.message;
                    statusDiv.className = 'upload-status error';
                }
            } catch (error) {
                statusDiv.innerHTML = 'Error: ' + error.message;
                statusDiv.className = 'upload-status error';
            }
        });

        setInterval(function() {
            location.reload();
        }, 60000);
    </script>
}
